<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            .text-error {
                color: white;
                background-color: grey;
                padding: 0 .5rem;
            }
            .text-correct {
                color: white;
                background-color: green;
                padding: 0 .5rem;
            }
            .text-wrong {
                color: white;
                background-color: red;
                padding: 0 .5rem;
            }
            ul#l > li {
                margin-bottom: .5rem;
            }
            div.note-sel {
                display: inline-block;
                margin: .3rem;
                padding: .3rem;
                background-color: lightgrey;
                cursor: pointer;
            }
            div.note-sel.selected {
                background-color: green;
            }
        </style>
    </head>

    <body>
        <h3 id="score">0 of -1</h3>
        <p>
            <div class="note-sel">A</div>
            <div class="note-sel">Bb</div>
            <div class="note-sel">B</div>
            <div class="note-sel">C</div>
            <div class="note-sel">C#</div>
            <div class="note-sel">D</div>
            <div class="note-sel">Eb</div>
            <div class="note-sel">E</div>
            <div class="note-sel">F</div>
            <div class="note-sel">F#</div>
            <div class="note-sel">G</div>
            <div class="note-sel">Ab</div>
        </p>
        <p id="t"></p>
        <p>
            <form>
                <input type="text" id="i" autocomplete='off'/>
                <button type="submit" id="go">Go</button>
            </form>
        </p>
        <ul id="l"></ul>
        <script>
            function start() {
                const notes = ['A','Bb','B','C', 'C#', 'D', 'Eb', 'E', 'F', 'F#',
                    'G', 'Ab'];

                const intervals = ['Perfect Unison (I)', 'Minor Second (Flat II)',
                    'Major Second (II)',
                    'Minor Third (Flat III)', 'Major Third (III)', 'Perfect Fourth (IV)',
                    'Tri-Tone (Flat V)', 'Perfect Fifth (V)', 'Minor Sixth (Flat VI)',
                    'Major Sixth', 'Minor Seventh (Flat VII)', 'Major Seventh (VII)',
                    'Perfect Octave'];

                let allowedNotes = Array.prototype.map.call(
                    document.querySelectorAll('div.note-sel.selected'),
                    el => el.innerText
                );
                if (!allowedNotes.length) {
                    allowedNotes = notes;
                }
                document.forms[0].onsubmit = () => {
                    submitAnswer();
                    return false;
                };
                const text = document.getElementById('t');
                const submit = document.getElementById('go');
                const input = document.getElementById('i');
                const list = document.getElementById('l');
                const scoreboard = document.getElementById('score');
                let score = 0, total = -1, sTime = 0, tTime = -1;

                const synonym = {
                    'A#': 'Bb',
                    'Db': 'C#',
                    'D#': 'Eb',
                    'Gb': 'F#',
                    'G#': 'Ab'
                };

                const noteMap = notes.reduce(
                    (nacc, n, nIdx) => ({ ...nacc, [n]: intervals.reduce(
                        (iacc, i, iIdx) => ({
                            ...iacc,
                            [i]: getNote(nIdx, iIdx)
                        }), {}
                    ) }), {}
                );

                function normalise(input) {
                    let normal = cF(input);
                    normal = synonym[normal] || normal;
                    if (notes.indexOf(normal) === -1){
                        return false;
                    }
                    return normal;
                }

                function getNote(nIdx, iIdx) {
                    const idx = parseInt(nIdx) + parseInt(iIdx);
                    if (idx > notes.length - 1) {
                        return notes[idx - (notes.length)];
                    }
                    return notes[idx];
                }

                function submitAnswer() {
                    const answer = normalise(i.value);
                    if (!answer) {
                        onError(`"${i.value}" is not a valid note`);
                        i.focus();
                        i.select();
                        return;
                    }
                    i.value = "";
                    const correct = getNote(t.dataset.note, t.dataset.interval);
                    if (cF(answer) === correct) {
                        onCorrect(text.innerText, correct);
                    } else {
                        onWrong(text.innerText, correct, answer);
                    }
                    newQuestion();
                }

                function cF(str) {
                    return str.charAt(0).toUpperCase() + str.slice(1);
                }
                
                function newQuestion() {
                    const nIdx = getAllowedRandomNote();
                    const iIdx = Math.round(Math.random() * (intervals.length - 1));
                    t.dataset.note = nIdx;
                    t.dataset.interval = iIdx;
                    text.innerHTML = `${intervals[iIdx]} of <strong>${notes[nIdx]}</strong>`;
                    total++;
                    const avgTime = tTime > -1 && ((tTime / score) / 1000).toFixed(2);
                    scoreboard.innerText = `${score} of ${total} ${avgTime ? ` - AVG ${avgTime}s` : ''}`;
                    i.focus();
                    sTime = Date.now();                
                }

                function getAllowedRandomNote() {
                    const nIdx = Math.round(Math.random() * (allowedNotes.length - 1));
                    console.log({ nIdx, al: allowedNotes[nIdx] });
                    return notes.indexOf(allowedNotes[nIdx]);
                }

                function onError(desc) {
                    output(`<strong class='text-error'>Error:</strong> ${desc}`);
                }

                function onCorrect(desc, correct) {
                    score++;
                    tTime += Date.now() - sTime;
                    output(`<strong class='text-correct'>Correct</strong> - The ${desc} is ${correct}`);
                }

                function onWrong(desc, correct, wrong) {
                    output(`<strong class='text-wrong'>Wrong</strong> - The ${desc}
                        is <strong><u>${correct}</u></strong>, not ${wrong}`);
                }

                function output(html) {
                    const li = document.createElement('li');
                    li.innerHTML = html;
                    list.insertBefore(li, list.firstChild);
                }

                newQuestion();
            }
            document.querySelectorAll('div.note-sel').forEach(
                el => el.addEventListener('click', () => {
                    if (el.classList.contains('selected')) {
                        el.classList.remove('selected');
                    } else {
                        el.classList.add('selected');
                    }
                    start();
                })
            );
            window.onload = start;
        </script>
    </body>
</html>
